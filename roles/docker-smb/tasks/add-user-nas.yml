---
- include_role:
    name: common
    tasks_from: load-config
  vars:
    file: "{{ config_file_smb }}"

- set_fact:
    smb_options: "{{ defaults.share }}"
    smb_users: "{{ defaults.user }}"
- set_fact:
    smb_options: "{{ smb_options | combine( { 'path': share_path }, recursive=true ) }}"
  when: share_path is defined

- set_fact:
    config: "{{ config | combine( { 'shares': { username: smb_options } }, recursive=true ) }}" # share name == username

- set_fact:
    config: "{{ config | combine( { 'users': { username: smb_users } }, recursive=true ) }}"

- name:  write updated users config
  include_role:
    name: common
    tasks_from: write-config
  vars:
    file: "{{ config_file_smb }}"
    content: "{{ config }}"
    do_backup: yes

- name: "Ensure nas directory is present: {{ smb_options.path }}."
  file:
    path: "{{ smb_options.path }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"
    mode: 0755
  become: yes

- include_tasks: main.yml
