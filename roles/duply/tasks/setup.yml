---
- include_tasks: sourcepath.yml

# share_name defaults to username (via group_vars)
- set_fact:
    profile_name: "{{ share_name }}"

- set_fact:
    cronjob_state: present
  when: cronjob is defined and cronjob | bool
- debug:
    msg: "Adding cronjob for backup profile: {{ profile_name }}"
  when: cronjob_state == "present"

- name: Create empty backup file list (if none exists)
  copy:
    content: "+ {{ source_path }}/{{ share_name }}"
    dest: "{{ config_dir_user }}/{{ backup_list_name }}"
    force: no # if it already exists, do nothing
    owner: "{{ username }}"
    group: khoe
    mode: 0640
  become: yes

  # Filelist format:
  #- /home/example1/nas/bar.txt
  #+ /home/example1/nas

- name: Read filelist
  command: "cat {{ config_dir_user }}/{{ backup_list_name }}"
  register: filelist
  changed_when: false

- name: Get hostname
  command: hostname
  register: hostname
  changed_when: false
  failed_when: false

- set_fact:
    target: "{{ backup_location }}/{{ hostname.stdout | default('khoe') }}-{{ username }}-{{ profile_name }}"

- debug:
    msg: "Creating duply profile '{{ profile_name }}' for user '{{ username }}'. \nBackup location: {{ target }} \nEncrypting with gpg key: {{ user.fingerprint }}"

- include_role:
    name: oefenweb.duply-backup
  vars:
    ansible_become: yes # oefenweb.duply is written to require root
    ansible_become_user: root
    duply_backup_profile_directory: "{{ profile_dir }}" # default set by oefenweb.duply: `/etc/duply/[profile_name]`
    duply_backup_profiles:
      '{{ profile_name }}':
        conf:
          gpg_key: "{{ user.fingerprint }}"
          gpg_pw: "{{ passphrase | default('') }}"

          source: "{{ source_path }}"
          target: "{{ target }}"
          # remote auth. Duply removed this functionality. Need to set env vars in backup.yml
          #target_user: "{{ remote_backup_key }}", #target_pass: "{{ remote_backup_psw }}"

          max_age: "{{ max_age }}" # Time frame for old backups to keep
          max_fullbkp_age: "{{ max_fullbkp_age }}" # Perform a full backup if latest full backup in the collection is older than the given time
          max_fulls_with_incrs: "{{ max_fulls_with_incrs }}" # Number of full backups for which incrementals will be kept for

          #dupl_params: null
          #verbosity: 5
          #arch_dir: '/data/backup/.duply-cache'

        # pre: ../../../files/duply-backup/pre
        # post: ../../../files/duply-backup/post
        excludes: "{{ ['- '+ restore_target] + filelist.stdout_lines + ['- **'] }}"

    duply_backup_jobs:
      - name: "duply-{{ username }}-{{ profile_name }}"
        state: "{{ cronjob_state }}"
        job: "/usr/local/bin/duply {{ profile_dir }}/{{ profile_name }} backup"
        # run every day at 04:00
        minute: "0"
        hour: "4"

    # `cat /etc/cron.d/duply-backup` to verify


  # Using `sudo` like on the command line works, using `become` fails
  # hangs waiting for input
# - name: "Run a duply status command (to copy the gpg keys to the profile now)"
#   command: "sudo duply {{ profile_dir }}/{{ profile_name }} status"
#   register: duply
